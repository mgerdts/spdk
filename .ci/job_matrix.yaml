job: spdk

registry_host: harbor.mellanox.com
registry_path: /swx-storage/spdk
registry_auth: swx-storage

credentials:
  - {credentialsId: '311997c9-cc1c-4d5d-8ba2-6eb43ba0a06d', usernameVariable: 'REPO_USER', passwordVariable: 'REPO_PASS'}
  - {credentialsId: '3a89fb85-f7aa-40f2-bd7a-32be80588d95', usernameVariable: 'REPO_USER', passwordVariable: 'REPO_PASS'}

failFast: false
kubernetes:
  cloud: swx-k8s-spray
  namespace: snap-ci
  arch_table:
    aarch64:
      nodeSelector: 'feature.node.kubernetes.io/cpu-vendor=ARM'
    x86_64:
      nodeSelector: 'feature.node.kubernetes.io/cpu-vendor=AuthenticAMD'

volumes:
  - {mountPath: /auto/mtrswgwork, hostPath: /auto/mtrswgwork}

runs_on_dockers:
  - {file: '.ci/Dockerfile.ubuntu20.04', name: 'ubuntu2004ofed59', arch: 'x86_64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.ubuntu20.04', name: 'ubuntu2004ofed59', arch: 'aarch64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.ubuntu22.04', name: 'ubuntu2204ofed59', arch: 'x86_64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.ubuntu22.04', name: 'ubuntu2204ofed59', arch: 'aarch64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.centos7.9.2009', name: 'centos79ofed59', arch: 'x86_64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.centos7.9.2009', name: 'centos79ofed59', arch: 'aarch64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.centos8.2.2004', name: 'centos82ofed59', arch: 'x86_64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.centos8.2.2004', name: 'centos82ofed59', arch: 'aarch64', tag: '5.9-0.1.9.0'}
  - {file: '.ci/Dockerfile.openeuler.20.03', name: 'openeuler2003ofed59', arch: 'aarch64', tag: '5.9-0.1.9.0'}

steps:
  - name: Set correct rights
    run: |
      uid=$(id -u)
      gid=$(id -g)
      sudo chown -R $uid:$gid $WORKSPACE

  - name: Build distro package
    run: |
      if [[ -e /etc/redhat-release || -e /etc/openEuler-release ]]; then
        .ci/build_rpm.sh
      elif [ -e /etc/debian_version ]; then
        .ci/build_deb.sh
      else
        echo "[ERROR]: Unsupported OS!"
        exit 1
      fi

  - name: Upload distro package NEXUS
    enable: true
    credentialsId: '311997c9-cc1c-4d5d-8ba2-6eb43ba0a06d'
    resource: actions/nexus.py
    containerSelector:
      - "{name: 'ubuntu2004ofed59', variant:1}"
      - "{name: 'ubuntu2204ofed59', variant:1}"
      - "{name: 'centos79ofed59', variant:1}"
      - "{name: 'centos82ofed59', variant:1}"
      - "{name: 'openeuler2003ofed59', variant:1}"
    run: |
      .ci/upload.sh nexus

  - name: Upload distro package URM
    enable: true
    credentialsId: '3a89fb85-f7aa-40f2-bd7a-32be80588d95'
    resource: actions/nexus.py
    containerSelector:
      - "{name: 'ubuntu2004ofed59', variant:1}"
      - "{name: 'ubuntu2204ofed59', variant:1}"
      - "{name: 'centos79ofed59', variant:1}"
      - "{name: 'centos82ofed59', variant:1}"
      - "{name: 'openeuler2003ofed59', variant:1}"
    run: |
      .ci/upload.sh urm

pipeline_stop:
  run: |
    if [[ "$pipeline_status" == "SUCCESS" ]]; then
      .ci/git_tag.sh
    fi
